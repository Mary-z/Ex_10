# ETL Project
***
Данный проект является ETL-процессом. Генерируется 1 млн. записей - продаж, затем данные обрабатываются, производится аналитика, результаты аналитики отправляются в Clickhouse. 

## Инструкция по запуску

### Собираем Docker-образы

Чтобы собрать и запустить Docker-образы необходимо поочередно запустить команды:

```bash
docker-compose build
docker-compose up airflow-init
docker-compose up
```

При первом запуске после построения необходимо создать подключения к базам данных в Airflow. Для этого необходимо подключиться к любому образу Airflow по его id:

```bash
docker ps | grep airflow
docker exec -it <CONTAINER ID> bash
```
И внутри контейнера запустить connections.sh:

```bash
sh connections.sh
```
Для остановки работы Docker-контейнеров выполните:

```bash
docker-compose down
```

## Сервисы

| Сервис        | Адрес                   | Пользователь | Пароль   |
|---------------|-------------------------|--------------|----------|
| Airflow       | http://localhost:8080    | airflow      | airflow  |
| PostgreSQL    | http://localhost:5432    | user         | password |
| ClickHouse    | http://localhost:9000    | user         | password |


## Условия задания


### Подготовка данных
Необходимо сгенерировать 1 млн. записей о продажах за последний год, при помощи PySpark очистить их и привести к нужным форматам, загрузить в PostgreSQL.

### Аналитика

- С PySpark необходимо рассчитать общее количество и сумму продаж для каждого региона и каждого продукта; Рассчитать средний чек по регионам и продуктам
- Сохранить агрегированные данные в отдельную таблицу в PostgreSQL

### Загрузка результатов аналитики в ClickHouse

Агрегированные данные из PostgreSQL загружаются в таблицу в ClickHouse вместе с датой импорта

## Структура проекта

В директории dags лежит даг sales_analysis.py и папка sql со скриптами для создания таблиц. В папке plugins/operators - python модули по генерации, очистке, и анализу данных. Файл connections.sh запускается вручную внутри любого контейнера airflow при первом запуске приложения. Dockerfile содержит инструкции для образа Airflow.